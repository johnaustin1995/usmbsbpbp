# NCAA Baseball Score API (D1 + StatBroadcast)

This service scrapes D1 Baseball matchups/scores and enriches games that use StatBroadcast live stats.

## What It Does

- Pulls games from `https://d1baseball.com/scores/` via D1's dynamic scores endpoint.
- Extracts the StatBroadcast game `id` from each game's `Live Stats` link.
- Fetches live game summaries from StatBroadcast's webservice.
- Exposes clean JSON endpoints you can use in your website.

## Quick Start

```bash
npm install
npm run dev
```

Server default: `http://localhost:8787`

Frontend scoreboard page: `http://localhost:8787/`
Frontend teams page: `http://localhost:8787/teams.html`

The page includes:
- A date picker
- Previous/next day controls
- A Today button
- Auto-refresh toggle (defaults to every 60 seconds)
- Game cards + ticker rendered from `GET /api/scores?view=frontend`
- Clicking a StatBroadcast game opens a game dashboard page:
  - `http://localhost:8787/game.html?id=<statbroadcastId>`
  - The dashboard loads all available live stat views and renders tables for that game
- Teams page:
  - `http://localhost:8787/teams.html`
  - searchable directory + conference filters
  - full team view (schedule + season stats tables) backed by `GET /api/teams`

## Endpoints

### `GET /health`

Basic heartbeat.

### `GET /api/scores`

Query params:

- `date` (optional): `YYYYMMDD` or `YYYY-MM-DD`. Defaults to today in US Eastern Time.
- `statbroadcastOnly` (optional): `true/false` (or `1/0`).
- `includeLive` (optional): `true/false` (or `1/0`). When true, StatBroadcast games include parsed live summaries.
- `view` (optional): `raw`, `frontend`, or `both` (default: `both`).
  - `frontend` returns a normalized UI payload with:
    - `cards[]` for scoreboard cards
    - `ticker[]` for compact ticker text rows

Example:

```bash
curl "http://localhost:8787/api/scores?date=20260213&includeLive=true"
```

### `GET /api/teams`

Returns the most recent teams JSON generated by `npm run teams:json`.

Query params:

- `slim` (optional): `true/false` (or `1/0`). When true, returns a lightweight directory list.
- `team` (optional): team lookup key (slug, numeric id, or team name).
- `season` (optional): `YYYY`. Picks the latest file matching that season when multiple exports exist.
- `file` (optional): explicit JSON filename in `data/tmp/teams/`.

Examples:

```bash
curl "http://localhost:8787/api/teams?slim=true"
curl "http://localhost:8787/api/teams?team=alabama"
curl "http://localhost:8787/api/teams?season=2026&team=144358"
```

### `GET /api/live/:id`

Fetch a single StatBroadcast live summary.

Query params:

- `view` (optional): `raw`, `frontend`, or `both` (default: `raw`).

Example:

```bash
curl "http://localhost:8787/api/live/636528"
```

### `GET /api/live?ids=...`

Fetch multiple StatBroadcast games at once.

Query params:

- `view` (optional): `raw`, `frontend`, or `both` (default: `raw`).

Example:

```bash
curl "http://localhost:8787/api/live?ids=636528,635966,631957"
```

### `GET /api/live/:id/stats`

Returns structured statistical data scraped from StatBroadcast tables (not just the live link).

Query params:

- `view` (optional): defaults to `game`

Baseball-supported views:

- `game`
- `lineups`
- `away_box`
- `home_box`
- `compare`
- `scoring`
- `plays`
- `plays_inning_1` ... `plays_inning_20` (dynamic inning play-by-play)
- `scorecard_away`
- `scorecard_home`
- `away_season`
- `home_season`
- `notes`

Example:

```bash
curl "http://localhost:8787/api/live/636528/stats?view=home_box"
```

### `GET /api/live/:id/final`

Builds a postgame-friendly payload by combining multiple StatBroadcast views:

- final score + winner
- winning/losing/saving pitcher (if available)
- away/home lineups
- away/home box + pitching stats
- scoring summary plays
- inning-by-inning play-by-play
- notes/docs section data

Query params:

- `requireFinal` (optional): `true/false`. If `true`, returns `409` until the game is detected as final.

Example:

```bash
curl "http://localhost:8787/api/live/636528/final?requireFinal=true"
```

### `GET /api/live/:id/pdf-json`

Downloads the same StatBroadcast print PDF used by the Tools menu, extracts text per page, and returns JSON.

Query params:

- `xsl` (optional): print template. Defaults to `baseball/sb.bsgame.print.book.xsl`.
- `includeFinalGame` (optional): `true/false`, defaults to `true`. When true, includes the existing structured final-game JSON in the same response.
- `includeRawPdf` (optional): `true/false`, defaults to `false`. Keep `false` for API usage; set `true` only for debugging raw PDF text extraction.

Response includes:

- `pdf` metadata (`bytes`, `sha256`, `pageCount`) and optional raw text (`pages[]`, `fullText`) only when `includeRawPdf=true`
- `finalGame` existing structured scrape
- `baseballScorekeeping` baseball-specific normalized schema (`schemaVersion: 2.0.0`):
  - `game` metadata
  - `teams.away|home` with line score + batting/pitching box score lines
  - `participants.players` dictionary with stable `playerId`s
  - canonical `plays[]` timeline (single source of truth) with:
    - `result` outcome/tags/runs
    - `pitchContext` count + pitch sequence parsing
    - `scoring.decisionContext` including location parsing and source (`text` overrides scorecard codes)
  - `indexes` for fast access (`scoringPlayIds`, `playIdsByInning`)

Example:

```bash
curl "http://localhost:8787/api/live/635076/pdf-json"
```

Debug raw extraction example:

```bash
curl "http://localhost:8787/api/live/635076/pdf-json?includeRawPdf=true"
```

Direct StatBroadcast print template examples for baseball:

- `baseball/sb.bsgame.print.book.xsl` (full game book)
- `baseball/sb.bsgame.print.ncaabox.xsl`
- `baseball/sb.bsgame.print.scoring.xsl`
- `baseball/sb.bsgame.print.fullpxp.xsl`

## Frontend Shape

`view=frontend` for `/api/scores` gives a feed like:

```json
{
  "date": "20260213",
  "updatedAt": "2026-02-13 11:42:56 am",
  "totalGames": 117,
  "cards": [
    {
      "id": "0ecd4d93141245ff9cb08e5f078c23c3",
      "phase": "live",
      "status": "Top 7th",
      "liveSituation": {
        "inningText": "Top 7th",
        "count": { "balls": 3, "strikes": 2 },
        "outs": 1,
        "bases": { "first": true, "second": false, "third": true },
        "batter": { "name": "Springer", "summary": "0-1" },
        "pitcher": { "name": "Chapman", "pitchCount": 6 }
      },
      "teams": [
        { "side": "away", "name": "Wake Forest", "rank": 21, "score": 2 },
        { "side": "home", "name": "Houston", "rank": null, "score": 6 }
      ]
    }
  ],
  "ticker": [
    {
      "id": "0ecd4d93141245ff9cb08e5f078c23c3",
      "text": "Wake Forest 2 at Houston 6 â€¢ Top 7th"
    }
  ]
}
```

Note: `liveSituation` fields can be partially null depending on what a specific StatBroadcast feed exposes in real time.

## Notes

- Not every D1 game uses StatBroadcast. Those games will have `statbroadcastId = null`.
- Basic in-memory caching is enabled to reduce duplicate upstream requests.
- This scraper depends on third-party HTML/APIs that can change.

## Scripts

- `npm run dev`: start in watch mode with `tsx`
- `npm run build`: compile TypeScript to `dist/`
- `npm run start`: run compiled server
- `npm run test`: run parser tests
- `npm run import:branding`: fetch ESPN + teamcolors, merge data, download logos locally
- `npm run import:branding:meta`: same merge, but skip logo downloads
- `npm run pdf:json -- --url https://stats.statbroadcast.com/broadcast/?id=635076`: download PDF and write structured JSON to `data/tmp/pdf-json/`
- `npm run pdf:json -- --url https://stats.statbroadcast.com/broadcast/?id=635076 --include-raw-pdf`: include raw extracted PDF text in output (debug mode)
- `npm run teams:json -- --season 2026`: scrape D1 teams directory + conference membership + full team schedules/stats into `data/tmp/teams/`
- `npm run x:feed -- --id 636528 --dry-run --once`: run one live play-by-play cycle for X posting
- `npm run x:preview -- --id 636528`: watch live plays and print would-be X posts to console only (no posting)
- `npm run x:verify`: verify X credentials and print the authenticated user
- `npm run x:daemon`: discover Southern Miss games and auto-start `x:feed` near first pitch

## X Play-By-Play Feed

Use the live StatBroadcast play-by-play scraper to publish automated X posts.

1. Create an X app with write permissions and collect user-context credentials.
2. Add credentials to `.env` (recommended) or export them in your shell:

```bash
cp .env.example .env
```

```bash
export X_API_KEY="..."
export X_API_SECRET="..."
export X_ACCESS_TOKEN="..."
export X_ACCESS_TOKEN_SECRET="..."
```

3. Verify auth:

```bash
npm run x:verify
```

4. Run the feed worker:

```bash
npm run x:feed -- --id 636528 --interval 20
```

Automatic VPS mode:

```bash
npm run x:daemon
```

Recommended safe start:

```bash
npm run x:feed -- --id 636528 --dry-run --once
```

Quick preview (console only, zero posting/state effects):

```bash
npm run x:preview -- --id 636528
```

`x:preview` runs continuously by default. Stop with `Ctrl+C`.
Use `--once` for a single polling cycle.
Both `x:preview` and `x:feed` are restricted to games where either team is Southern Miss.

Useful flags:

```bash
npm run x:feed -- --id 636528 --bootstrap all
npm run x:feed -- --id 636528 --thread-mode none
npm run x:feed -- --id 636528 --max-posts 10 --tag "#NCAABaseball"
npm run x:feed -- --id 636528 --state data/tmp/x-feed/my-game.json
npm run x:preview -- --id 636528 --limit 25 --tag "#NCAABaseball"
npm run x:preview -- --id 636528 --interval 10 --bootstrap latest
npm run x:preview -- --id 636528 --once
npm run x:daemon -- --interval 60 --start-lead 1800 --feed-interval 20
npm run x:daemon -- --feed-dry-run
```

Environment variable overrides:

- `X_FEED_GAME_ID`
- `X_FEED_INTERVAL_SECONDS` (default `20`)
- `X_FEED_BOOTSTRAP` (`latest` default, or `all`)
- `X_FEED_THREAD_MODE` (`reply` default, or `none`)
- `X_FEED_MAX_POSTS_PER_CYCLE` (default `6`)
- `X_FEED_POST_FINAL` (`true` default)
- `X_FEED_APPEND_TAG`
- `X_API_BASE_URL` (optional, defaults to `https://api.x.com`)
- `X_DAEMON_INTERVAL_SECONDS` (default `60`)
- `X_DAEMON_START_LEAD_SECONDS` (default `1800`)
- `X_DAEMON_FEED_DRY_RUN` (default `false`)
- `X_DAEMON_FEED_INTERVAL_SECONDS` (optional)

### VPS (Docker Compose) setup

`Dockerfile` and `docker-compose.yml` are included.

Example deploy flow:

```bash
bash scripts/build-vps-bundle.sh
scp artifacts/ncaabsb-vps-bundle-*.zip user@vps:/tmp/ncaabsb-vps-bundle.zip
ssh user@vps
unzip -q /tmp/ncaabsb-vps-bundle.zip -d /tmp/ncaabsb-bootstrap
sudo bash /tmp/ncaabsb-bootstrap/deploy/vps/bootstrap-ubuntu-docker.sh /tmp/ncaabsb-vps-bundle.zip
sudo -u ncaabsb nano /opt/ncaabsb/current/.env
cd /opt/ncaabsb/current && sudo docker compose up -d --build
```

Logs:

```bash
cd /opt/ncaabsb/current
sudo docker compose logs -f usmbsb-x-daemon
```

Update with a new zip:

```bash
sudo bash /opt/ncaabsb/current/deploy/vps/update-release-docker.sh /tmp/ncaabsb-vps-bundle.zip
```

### VPS (systemd) setup

Example service file (`/etc/systemd/system/usmbsb-x-daemon.service`):

```ini
[Unit]
Description=Southern Miss Baseball X Daemon
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=YOUR_USER
WorkingDirectory=/path/to/ncaabsb
Environment=NODE_ENV=production
ExecStart=/usr/bin/npm run x:daemon
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Then:

```bash
sudo systemctl daemon-reload
sudo systemctl enable usmbsb-x-daemon
sudo systemctl start usmbsb-x-daemon
sudo systemctl status usmbsb-x-daemon
journalctl -u usmbsb-x-daemon -f
```

## Teams Database Scraper

Build a full D1 teams payload suitable for database import:

```bash
npm run teams:json -- --season 2026
```

Useful flags:

```bash
npm run teams:json -- --limit 25
npm run teams:json -- --concurrency 6 --conference-concurrency 3
npm run teams:json -- --out data/tmp/teams/d1-teams.json
npm run teams:json -- --no-stats
```

## Team Branding Import Pipeline

Pull school branding metadata into local files for UI use:

```bash
npm run import:branding
```

Optional flags:

```bash
npm run import:branding -- --skip-logos
npm run import:branding -- --force
npm run import:branding -- --limit 50
```

Generated files:

- `data/branding/raw/espn-teams.json`
- `data/branding/raw/teamcolors-ncaa.csv`
- `data/branding/team-branding.json`
- `public/data/team-branding.json`
- `public/assets/logos/teams/*`

Frontend usage:

- `public/branding.js` loads `public/data/team-branding.json`
- Scoreboard cards and game dashboard blocks automatically apply:
  - local team logos (`/assets/logos/teams/*`)
  - team primary/secondary color accents when a team match is found
